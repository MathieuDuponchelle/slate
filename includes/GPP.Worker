<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>API Documentation</title>

    <link href="../stylesheets/screen.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="../stylesheets/print.css" rel="stylesheet" type="text/css" media="print" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
      <script src="../javascripts/all_nosearch.js" type="text/javascript"></script>

  </head>

  <body class="includes includes_GPP">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="../images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <img src="../images/logo.png" />
      <div id="toc">
      </div>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h2 id="gpp.worker" c_name="GPPWorker" python_name="GPP.Worker">GPP.Worker</h2>

<p class="graphviz">
<!-- Generated by graphviz version 2.38.0 (20140413.2041) --><!-- Title: %3 Pages: 1 --><svg width="110pt" height="116pt" viewBox="0.00 0.00 110.00 116.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 112)"><title>%3</title><polygon fill="white" stroke="none" points="-4,4 -4,-112 106,-112 106,4 -4,4"/><!-- GObject.Object --><g id="node1" class="node"><title>GObject.Object</title><g id="a_node1"><a xlink:href="https://developer.gnome.org/gobject/unstable//gobject-The-Base-Object-Type.html#GObject" xlink:title="GObject.Object"><path fill="none" stroke="black" d="M90,-108C90,-108 12,-108 12,-108 6,-108 0,-102 0,-96 0,-96 0,-84 0,-84 0,-78 6,-72 12,-72 12,-72 90,-72 90,-72 96,-72 102,-78 102,-84 102,-84 102,-96 102,-96 102,-102 96,-108 90,-108"/><text text-anchor="middle" x="51" y="-86.3" font-family="Times,serif" font-size="14.00">GObject.Object</text></a></g></g><!-- GPP.Worker --><g id="node2" class="node"><title>GPP.Worker</title><g id="a_node2"><a xlink:href="#gpp.worker" xlink:title="GPP.Worker"><path fill="none" stroke="black" d="M82.5,-36C82.5,-36 19.5,-36 19.5,-36 13.5,-36 7.5,-30 7.5,-24 7.5,-24 7.5,-12 7.5,-12 7.5,-6 13.5,-0 19.5,-0 19.5,-0 82.5,-0 82.5,-0 88.5,-0 94.5,-6 94.5,-12 94.5,-12 94.5,-24 94.5,-24 94.5,-30 88.5,-36 82.5,-36"/><text text-anchor="middle" x="51" y="-14.3" font-family="Times,serif" font-size="14.00">GPP.Worker</text></a></g></g><!-- GObject.Object&#45;&gt;GPP.Worker --><g id="edge1" class="edge"><title>GObject.Object&#45;&gt;GPP.Worker</title><path fill="none" stroke="black" d="M51,-71.6966C51,-63.9827 51,-54.7125 51,-46.1124"/><polygon fill="black" stroke="black" points="54.5001,-46.1043 51,-36.1043 47.5001,-46.1044 54.5001,-46.1043"/></g></g></svg></p>

<p><a href="#gpp.worker">GPP.Worker</a> receives requests from a <a href="#gpp.queue">GPP.Queue</a>, transmits them
as a simple string to the user, and notifies the queue when the
user marks the task as done.</p>

<blockquote>
<p>Set up and start a simple worker, which will take a lot of time to multiply the request by 2, and sometimes inexplicably fail.</p>
</blockquote>
<pre class="highlight c"><code><span class="cp">#include &lt;glib-unix.h&gt;
</span>
<span class="cp">#include "gpp.h"
</span>
<span class="cp">#define FAILURE_ODDS 4
</span>
<span class="cp">#define GPP_TYPE_MULTIPLYING_WORKER (gpp_multiplying_worker_get_type ())
</span>
<span class="n">G_DECLARE_FINAL_TYPE</span> <span class="p">(</span><span class="n">GPPMultiplyingWorker</span><span class="p">,</span> <span class="n">gpp_multiplying_worker</span><span class="p">,</span> <span class="n">GPP</span><span class="p">,</span>
    <span class="n">MULTIPLYING_WORKER</span><span class="p">,</span> <span class="n">GPPWorker</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">_GPPMultiplyingWorker</span>
<span class="p">{</span>
  <span class="n">GPPWorker</span> <span class="n">parent</span><span class="p">;</span>
  <span class="n">GRand</span> <span class="o">*</span><span class="n">rand_source</span><span class="p">;</span>
  <span class="n">gchar</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">G_DEFINE_TYPE</span> <span class="p">(</span><span class="n">GPPMultiplyingWorker</span><span class="p">,</span> <span class="n">gpp_multiplying_worker</span><span class="p">,</span> <span class="n">GPP_TYPE_WORKER</span><span class="p">);</span>

<span class="k">static</span> <span class="n">gboolean</span>
<span class="nf">set_task_done</span> <span class="p">(</span><span class="n">GPPMultiplyingWorker</span> <span class="o">*</span> <span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"one task done</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">g_rand_int</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rand_source</span><span class="p">)</span> <span class="o">%</span> <span class="n">FAILURE_ODDS</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_print</span> <span class="p">(</span><span class="s">"Actually it didn't work sorry</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">gpp_worker_set_task_done</span> <span class="p">(</span><span class="n">GPP_WORKER</span> <span class="p">(</span><span class="n">self</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">g_print</span> <span class="p">(</span><span class="s">"no problem !!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">gpp_worker_set_task_done</span> <span class="p">(</span><span class="n">GPP_WORKER</span> <span class="p">(</span><span class="n">self</span><span class="p">),</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">gboolean</span>
<span class="nf">handle_request</span> <span class="p">(</span><span class="n">GPPWorker</span> <span class="o">*</span> <span class="n">worker</span><span class="p">,</span> <span class="k">const</span> <span class="n">gchar</span> <span class="o">*</span> <span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">GPPMultiplyingWorker</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">GPP_MULTIPLYING_WORKER</span> <span class="p">(</span><span class="n">worker</span><span class="p">);</span>
  <span class="n">g_print</span> <span class="p">(</span><span class="s">"doing one task, request is %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">g_rand_int</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rand_source</span><span class="p">)</span> <span class="o">%</span> <span class="n">FAILURE_ODDS</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_print</span> <span class="p">(</span><span class="s">"I can't even start</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">self</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">=</span> <span class="n">g_strdup_printf</span> <span class="p">(</span><span class="s">"Result : %d"</span><span class="p">,</span> <span class="n">atoi</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">g_timeout_add</span> <span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="p">(</span><span class="n">GSourceFunc</span><span class="p">)</span> <span class="n">set_task_done</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gpp_multiplying_worker_class_init</span> <span class="p">(</span><span class="n">GPPMultiplyingWorkerClass</span> <span class="o">*</span> <span class="n">klass</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">GPPWorkerClass</span> <span class="o">*</span><span class="n">gpp_worker_class</span> <span class="o">=</span> <span class="n">GPP_WORKER_CLASS</span> <span class="p">(</span><span class="n">klass</span><span class="p">);</span>

  <span class="n">gpp_worker_class</span><span class="o">-&gt;</span><span class="n">handle_request</span> <span class="o">=</span> <span class="n">handle_request</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gpp_multiplying_worker_init</span> <span class="p">(</span><span class="n">GPPMultiplyingWorker</span> <span class="o">*</span> <span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">rand_source</span> <span class="o">=</span> <span class="n">g_rand_new</span> <span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">gboolean</span>
<span class="nf">interrupted_cb</span> <span class="p">(</span><span class="n">GMainLoop</span> <span class="o">*</span> <span class="n">loop</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">g_main_loop_quit</span> <span class="p">(</span><span class="n">loop</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">GMainLoop</span> <span class="o">*</span><span class="n">loop</span> <span class="o">=</span> <span class="n">g_main_loop_new</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
  <span class="n">GPPMultiplyingWorker</span> <span class="o">*</span><span class="n">worker</span> <span class="o">=</span>
      <span class="n">g_object_new</span> <span class="p">(</span><span class="n">GPP_TYPE_MULTIPLYING_WORKER</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="n">g_unix_signal_add_full</span> <span class="p">(</span><span class="n">G_PRIORITY_HIGH</span><span class="p">,</span> <span class="n">SIGINT</span><span class="p">,</span> <span class="p">(</span><span class="n">GSourceFunc</span><span class="p">)</span> <span class="n">interrupted_cb</span><span class="p">,</span>
      <span class="n">loop</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="n">gpp_worker_start</span> <span class="p">(</span><span class="n">GPP_WORKER</span> <span class="p">(</span><span class="n">worker</span><span class="p">));</span>

  <span class="n">g_main_loop_run</span> <span class="p">(</span><span class="n">loop</span><span class="p">);</span>
  <span class="n">g_object_unref</span> <span class="p">(</span><span class="n">worker</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre>

<p><h3 id='JyvCnJ' class='subsection'><u>Methods:</u></h3></p>

<div class='prototype_start'></div>

<h3 id="gpp.worker.new" c_name="gpp_worker_new">GPP.Worker.new</h3>
<pre class="highlight c"><code><span class="n">GPPWorker</span><span class="o">*</span> <span class="n">gpp_worker_new</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

</code></pre>

<p><em>Returns</em>: the newly-created <a href="#gpp.worker">GPP.Worker</a>.</p>

<div class='prototype_end'></div>

<p>Create a new <a href="#gpp.worker">GPP.Worker</a>, which doesn&rsquo;t yet listen to request from
the <a href="#gpp.queue">GPP.Queue</a>.
Start it with <a href="#gpp.worker.start">GPP.Worker.start</a></p>

<div class='prototype_start'></div>

<h3 id="gpp.worker.start" c_name="gpp_worker_start" python_name="GPP.Worker.start">GPP.Worker.start</h3>
<pre class="highlight c"><code><span class="n">gboolean</span> <span class="n">gpp_worker_start</span> <span class="p">(</span><span class="n">GPPWorker</span><span class="o">*</span> <span class="n">self</span><span class="p">);</span>

</code></pre>
<pre class="highlight python"><code><span class="nd">@accepts</span><span class="p">(</span><span class="n">GPP</span><span class="o">.</span><span class="n">Worker</span><span class="p">)</span>
<span class="nd">@returns</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># Python wrapper for gpp_worker_start()</span>

</code></pre>

<p><em>self</em>: A <a href="#gpp.worker">GPP.Worker</a> that will start handling requests.</p>

<p><em>Returns</em>: <strong>TRUE</strong> if <strong>self</strong> could be started, <strong>FALSE</strong> if it was already.</p>

<div class='prototype_end'></div>

<p>This will make <strong>self</strong> start handling requests.</p>

<div class='prototype_start'></div>

<h3 id="gpp.worker.set_task_done" c_name="gpp_worker_set_task_done" python_name="GPP.Worker.set_task_done">GPP.Worker.set_task_done</h3>
<pre class="highlight c"><code><span class="n">gboolean</span> <span class="n">gpp_worker_set_task_done</span> <span class="p">(</span><span class="n">GPPWorker</span><span class="o">*</span> <span class="n">self</span><span class="p">,</span>
                                   <span class="k">const</span> <span class="n">gchar</span><span class="o">*</span> <span class="n">reply</span><span class="p">,</span>
                                   <span class="n">gboolean</span> <span class="n">success</span><span class="p">);</span>

</code></pre>
<pre class="highlight python"><code><span class="nd">@accepts</span><span class="p">(</span><span class="n">GPP</span><span class="o">.</span><span class="n">Worker</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
<span class="nd">@returns</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">set_task_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">success</span><span class="p">):</span>
    <span class="c"># Python wrapper for gpp_worker_set_task_done()</span>

</code></pre>

<p><em>self</em>: A <a href="#gpp.worker">GPP.Worker</a>.</p>

<p><em>reply</em>: A string that will be passed to the client.</p>

<p><em>success</em>: Whether the task was successfully handled.</p>

<p><em>Returns</em>: <strong>TRUE</strong> if the task was marked as done, <strong>FALSE</strong> otherwise.</p>

<div class='prototype_end'></div>

<p>Call this function when your worker has finished handling a task.</p>

<h3 id='uDUkkI' class='subsection'><u>Virtual Methods:</u></h3>

<div class='prototype_start'></div>

<h3 id="gpp.worker.do_handle_request" c_name="GPPWorkerClass:handle_request" python_name="GPP.Worker.do_handle_request">GPP.Worker.do_handle_request</h3>
<pre class="highlight c"><code><span class="n">gboolean</span> <span class="n">GPPWorkerClass</span><span class="o">-&gt;</span><span class="n">handle_request</span> <span class="p">(</span><span class="n">GPPWorker</span><span class="o">*</span> <span class="n">self</span><span class="p">,</span>
                               <span class="k">const</span> <span class="n">gchar</span><span class="o">*</span> <span class="n">request</span><span class="p">);</span>

</code></pre>
<pre class="highlight python"><code><span class="nd">@accepts</span><span class="p">(</span><span class="n">GPP</span><span class="o">.</span><span class="n">Worker</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)</span>
<span class="nd">@returns</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">do_handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>

</code></pre>

<p><em>self</em>: the <a href="#gpp.worker">GPP.Worker</a></p>

<p><em>request</em>: The request to handle</p>

<p><em>Returns</em>: <strong>TRUE</strong> if the worker can handle that request, <strong>FALSE</strong> otherwise.</p>

<div class='prototype_end'></div>

<p>Implement this method to handle requests, requests <em>MUST</em> be
handled asynchronously as this method should not block, call
<a href="#gpp.worker.set_task_done">GPP.Worker.set_task_done</a> when the request has been handled.</p>

      </div>
      <div class="dark-box">
      </div>
    </div>
  </body>
</html>
